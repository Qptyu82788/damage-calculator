<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>綜合傷害計算器｜玩家版（簡化輸入）</title>
  <style>
    :root{
      --fg:#0f172a; --bg:#f5f7fb; --card:#ffffff; --line:#e2e8f0;
      --sub:#64748b; --accent:#16a34a; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:860px;margin:0 auto;padding:14px}
    h1{font-size:20px;margin:6px 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 0}
    label{display:block;font-size:12px;color:var(--sub);margin-bottom:6px}
    input,select,button{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:0}
    .btn{cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.danger{background:#fff;color:var(--danger);border-color:var(--danger)}
    .kpi{display:flex;gap:10px}
    .kpi .box{flex:1;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
    .box .title{font-size:12px;color:var(--sub);margin-bottom:6px}
    .box .value{font-size:24px;font-weight:800}
    .players{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(max-width:700px){.players{grid-template-columns:1fr}}
    .pcard{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .pcard .head{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .pcard .namewrap{display:flex;gap:8px;align-items:center;flex:1;min-width:0}
    .statrow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .actionrow{display:grid;grid-template-columns:1fr auto auto;gap:8px}
    .muted{color:#94a3b8;font-size:12px}
    .hp-dead{color:var(--danger);font-weight:700}
    .log{background:#0b1020;color:#9ee6a6;border-radius:12px;padding:10px;height:140px;overflow:auto;font-family:ui-monospace,Consolas,Menlo,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>綜合傷害計算器｜玩家版（簡化輸入）</h1>

    <!-- 只保留四個輸入：攻擊、倍率、人數、附加傷害 -->
    <div class="card">
      <div class="row">
        <div>
          <label>攻擊</label>
          <input id="atk" type="number" inputmode="decimal" min="0" step="1" placeholder="例如 1200">
        </div>
        <div>
          <label>倍率</label>
          <input id="rate" type="number" inputmode="decimal" min="0" step="0.1" placeholder="例如 1 或 1.5">
        </div>
      </div>
      <div class="row">
        <div>
          <label>人數（平均分攤）</label>
          <input id="playersCount" type="number" inputmode="numeric" min="1" step="1" value="1">
          <div class="muted">輸入需要分攤的人數（例：你以外還有 3 人 → 輸入 3）。</div>
        </div>
        <div>
          <label>附加傷害（可正可負，計入取整前）</label>
          <input id="extra" type="number" inputmode="decimal" step="1" placeholder="例如 200 或 -50">
        </div>
      </div>
    </div>

    <!-- 結果 -->
    <div class="card">
      <div class="kpi">
        <div class="box">
          <div class="title">綜合傷害</div>
          <div id="total" class="value">0</div>
        </div>
        <div class="box">
          <div class="title">每位玩家受到的傷害（平均）</div>
          <div id="per" class="value">0</div>
        </div>
      </div>
      <div class="muted" id="formulaText" style="margin-top:8px;">
        公式：綜合傷害 ＝ 攻擊 × 倍率 ＋ 附加傷害；每位玩家＝綜合傷害 ÷ 人數
      </div>
    </div>

    <!-- 施放者與套用 -->
    <div class="card">
      <h2 style="font-size:16px;margin:0 0 8px;">施放者與套用</h2>
      <div class="row" style="align-items:flex-end;">
        <div>
          <label>我是誰</label>
          <select id="caster"></select>
        </div>
        <div>
          <label>扣血預覽</label>
          <div class="muted">除了施放者外、在場者各扣 <span id="perPreview">0</span>（會再套各自減傷%）</div>
        </div>
        <div>
          <button id="apply" class="btn primary">✅ 套用傷害</button>
        </div>
      </div>
    </div>

    <!-- 玩家狀態 -->
    <div class="card">
      <h2 style="font-size:16px;margin:0 0 8px;">玩家狀態（可自訂名稱、回血、回滿、減傷）</h2>
      <div class="players" id="playersWrap"></div>
      <div class="row" style="margin-top:8px;">
        <button id="healAll" class="btn">全體回滿（依各自上限）</button>
        <button id="resetHP" class="btn danger">清空目前HP</button>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:16px;margin:0 0 8px;">紀錄</h2>
      <div class="log" id="log"></div>
    </div>

    <div class="muted">資料會存到本機（localStorage）。</div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    // ====== 只剩四個欄位 ======
    const atk=$('atk'), rate=$('rate'), extra=$('extra'), playersCount=$('playersCount');
    const total=$('total'), per=$('per'), perPreview=$('perPreview'), formulaText=$('formulaText');
    const caster=$('caster'), applyBtn=$('apply');
    const healAllBtn=$('healAll'), resetHPBtn=$('resetHP'), playersWrap=$('playersWrap'), logBox=$('log');

    const COUNT=4;
    const LS_KEY='calc_players_simple_v2_2';
    let players=Array.from({length:COUNT},(_,k)=>({
      name:`玩家${k+1}`, active:true, max:2000, hp:2000, dr:0, heal:200
    }));

    function log(msg){
      const time=new Date().toLocaleTimeString();
      logBox.innerHTML += `[${time}] ${msg}<br>`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    // === 計算 ===
    function calc(){
      const A=parseFloat(atk.value||'0');
      const R=parseFloat(rate.value||'0') || 1;
      const E=parseFloat(extra.value||'0');
      const N=Math.max(1, parseInt(playersCount.value||'1',10));

      const totalRaw = A*R + E;
      const perPlayer = totalRaw / N;

      const fmt = v => isFinite(v) ? (Math.abs(v)>=1e6 ? v.toFixed(0) : v.toLocaleString()) : '0';
      total.textContent = fmt(totalRaw);
      per.textContent = isFinite(perPlayer) ? perPlayer.toLocaleString(undefined,{maximumFractionDigits:2}) : '0';
      perPreview.textContent = per.textContent;

      formulaText.textContent = `公式：${A} × ${R} + ${E}，每位＝綜合 ÷ ${N}`;

      updateCasterOptions();
      saveState();
    }

    // === 施放者套用 ===
    function applyDamage(){
      const basePer=parseFloat(per.textContent.replace(/,/g,'')) || 0;
      if(basePer<=0){ log('目前每位玩家傷害為 0'); return; }
      const casterIdx=parseInt(caster.value,10);

      let hit=0;
      players.forEach((p,i)=>{
        if(i===casterIdx || !p.active) return;
        const dmg = Math.floor(basePer * (1 - Math.max(0, Math.min(95, p.dr))/100));
        const old = p.hp;
        p.hp = Math.max(0, old - dmg);
        hit++;
        log(`${p.name} 扣 ${dmg}（減傷${p.dr}%）→ ${p.hp}/${p.max}`);
      });
      if(!hit) log('沒有其他在場玩家');
      renderPlayers(); saveState();
    }

    // === 玩家卡片 ===
    function makePlayerCard(i){
      const p = players[i];
      const div=document.createElement('div'); div.className='pcard';
      div.innerHTML = `
        <div class="head">
          <div class="namewrap">
            <input id="name${i}" type="text" value="${p.name}" placeholder="玩家${i+1}" style="flex:1;min-width:0;">
          </div>
          <label class="muted"><input type="checkbox" id="alive${i}" ${p.active?'checked':''}> 在場</label>
        </div>
        <div class="statrow">
          <div><label>上限HP</label><input id="max${i}" type="number" min="0" step="1" value="${p.max}"></div>
          <div><label>目前HP</label><input id="hp${i}" type="number" step="1" value="${p.hp}"></div>
        </div>
        <div class="statrow">
          <div><label>回血數值</label><input id="heal${i}" type="number" step="1" value="${p.heal}"></div>
          <div><label>減傷(%)（0–95）</label><input id="dr${i}" type="number" min="0" max="95" step="1" value="${p.dr}"></div>
        </div>
        <div class="actionrow">
          <div></div>
          <button class="btn" id="healBtn${i}">+ 回血</button>
          <button class="btn" id="fullBtn${i}">回滿</button>
        </div>
        <div class="${(p.hp<=0 && p.active)?'hp-dead':'muted'}" id="state${i}">
          ${p.name}｜${p.active?'在場':'不在場'}｜上限 ${p.max}｜目前 ${p.hp}${p.dr>0?`｜減傷 ${p.dr}%`:''}${(p.hp<=0 && p.active)?'｜已陣亡':''}
        </div>
      `;
      return div;
    }

    function renderPlayers(){
      playersWrap.innerHTML='';
      for(let i=0;i<players.length;i++) playersWrap.appendChild(makePlayerCard(i));

      // 綁定事件
      for(let i=0;i<players.length;i++){
        const p=players[i];
        $('name'+i).addEventListener('input', e=>{ p.name=e.target.value; renderPlayers(); saveState(); });
        $('alive'+i).addEventListener('change', e=>{ p.active=e.target.checked; renderPlayers(); saveState(); });
        $('max'+i).addEventListener('input', e=>{
          p.max=parseInt(e.target.value||'0',10);
          if(p.hp>p.max) p.hp=p.max;
          renderPlayers(); saveState();
        });
        $('hp'+i).addEventListener('input', e=>{ p.hp=parseFloat(e.target.value||'0'); renderPlayers(); saveState(); });
        $('heal'+i).addEventListener('input', e=>{ p.heal=parseFloat(e.target.value||'0'); saveState(); });
        $('dr'+i).addEventListener('input', e=>{
          let v=parseFloat(e.target.value||'0'); v=Math.max(0, Math.min(95, v)); p.dr=v; e.target.value=String(v);
          renderPlayers(); saveState();
        });
        $('healBtn'+i).addEventListener('click', ()=>{
          const add = parseFloat(($('heal'+i).value)||'0');
          const old = p.hp; p.hp = Math.min(p.max, old + add);
          log(`${p.name} 回 ${add} → ${p.hp}/${p.max}`);
          renderPlayers(); saveState();
        });
        $('fullBtn'+i).addEventListener('click', ()=>{
          p.hp = p.max; log(`${p.name} 回滿至 ${p.max}`);
          renderPlayers(); saveState();
        });
      }
      updateCasterOptions();
    }

    function updateCasterOptions(){
      const cur = caster.value;
      caster.innerHTML='';
      players.forEach((p,i)=>{
        const opt=document.createElement('option');
        opt.value=String(i); opt.textContent=p.name;
        caster.appendChild(opt);
      });
      if(Array.from(caster.options).some(o=>o.value===cur)) caster.value=cur;
    }

    // === 快捷鍵 ===
    applyBtn.addEventListener('click', applyDamage);
    healAllBtn.addEventListener('click', ()=>{
      players.forEach(p=>{ if(p.max>0) p.hp=p.max; });
      renderPlayers(); log('全體回滿完成'); saveState();
    });
    resetHPBtn.addEventListener('click', ()=>{
      players.forEach(p=> p.hp=0);
      renderPlayers(); log('已清空目前HP'); saveState();
    });

    [atk,rate,extra,playersCount].forEach(el=> el.addEventListener('input', calc));
    caster.addEventListener('input', calc);

    // === 儲存 ===
    function saveState(){
      try{ localStorage.setItem(LS_KEY, JSON.stringify({
        atk:atk.value, rate:rate.value, extra:extra.value, playersCount:playersCount.value, players
      })); }catch(e){}
    }
    function loadState(){
      try{
        const raw=localStorage.getItem(LS_KEY);
        if(!raw) return;
        const s=JSON.parse(raw);
        atk.value=s.atk||''; rate.value=s.rate||''; extra.value=s.extra||''; playersCount.value=s.playersCount||'1';
        if(Array.isArray(s.players)) players=s.players;
      }catch(e){}
    }

    // === 初始化 ===
    loadState();
    renderPlayers();
    calc();
  </script>
</body>
</html>
